##  Cервис управления рассылками API администрирования и получения статистики.

## Основное задание :
Спроектировать и разработать сервис, который по заданным правилам запускает рассылку по списку клиентов.
 **Сущность "рассылка" имеет атрибуты:**
 - уникальный id рассылки
 - дата и время запуска рассылки
 - текст сообщения для доставки клиенту
 - фильтр свойств клиентов, на которых должна быть произведена рассылка (код мобильного оператора, тег)
 - дата и время окончания рассылки: если по каким-то причинам не успели разослать все сообщения - никакие сообщения клиентам после этого времени доставляться не должны
**Сущность "клиент" имеет атрибуты:**
 - уникальный id клиента
 - номер телефона клиента в формате 7XXXXXXXXXX (X - цифра от 0 до 9)
 - код мобильного оператора
 - тег (произвольная метка)
 - часовой пояс

**Сущность "сообщение" имеет атрибуты:**
 - уникальный id сообщения
 - дата и время создания (отправки)
 - статус отправки
 - id рассылки, в рамках которой было отправлено сообщение
- id клиента, которому отправили

**Спроектировать и реализовать API для:**

 - добавления нового клиента в справочник со всеми его атрибутами
 - обновления данных атрибутов клиента
 - удаления клиента из справочника
 - добавления новой рассылки со всеми её атрибутами
 - получения общей статистики по созданным рассылкам и количеству отправленных сообщений по ним с группировкой по статусам
 - получения детальной статистики отправленных сообщений по конкретной рассылке
 - обновления атрибутов рассылки
 - удаления рассылки
 - обработки активных рассылок и отправки сообщений клиентам

**Логика рассылки**
 - После создания новой рассылки, если текущее время больше времени начала и меньше времени окончания - должны быть выбраны из справочника все клиенты, которые подходят под значения фильтра, указанного в этой рассылке и запущена отправка для всех этих клиентов.
 - Если создаётся рассылка с временем старта в будущем - отправка должна стартовать автоматически по наступлению этого времени без дополнительных действий со стороны пользователя системы.
 - По ходу отправки сообщений должна собираться статистика (см. описание сущности "сообщение" выше) по каждому сообщению для последующего формирования отчётов.
 - Внешний сервис, который принимает отправляемые сообщения, может долго обрабатывать запрос, отвечать некорректными данными, на какое-то время вообще не принимать запросы. Необходимо реализовать корректную обработку подобных ошибок. Проблемы с внешним сервисом не должны влиять на стабильность работы разрабатываемого сервиса рассылок.


**Тесты находятся в :**
> distribution/tests

**При запушееном API ссылка на все методы [docks](http://localhost:8000/docs/)**
 
**[Ссылка на задание.](https://www.craft.do/s/n6OVYFVUpq0o6L)**

## Рабочее окружение

Для начала разработки необходимо настроить рабочее окружение. Нам понадобятся следующие системные зависимости: 
- [python](https://www.python.org/downloads/) версии 3.10.6 или выше
- менеджер зависимостей [poetry](https://python-poetry.org/docs/#installation) версии 1.2.0 или выше
- Настройка окружения:
1. Настроить репозиторий
    ```shell script
   git clone https://github.com/ClasterPack/db_Api.git db_Api
   cd notifications
    ```
   
2. Подключение виртуального окружения:
   ```shell script
   poetry shell
   ```
   
3. Установить зависимости. Зависимости установяться в виртуальное окружение.
    ```shell script
    poetry install
   ```
   При необходимости билда с тестированием установить:
   ```shell script
   poetry install -E devtools
   ```
   
4. В файле .evn заполнить необходимые данные:
```
TOKEN = '<your bearer token>'
   ```

5. Создать и применить миграции в базу данных:
   ```shell script
   python manage.py makemigrations
   python manage.py migrate
   ```

6. Запустить Django сервер:
```shell script
python manage.py runserver
```

7. Запустить менеджер задач Celery:
```shell script
celery -A notification_service worker -l info -E
```
8. Запускаем монитроинг Celery, Flower. Отслеживать можно [здесь](http://localhost:5566/):
```shell script
celery -A notifications flower --port=5566
```


